#### 硬盘及其主引导扇区

****

> 磁盘、硬盘在现在情况下我们可以认为是同一种存储介质

##### 1、目标

​	在之前学习[王爽]8086汇编语言程序设计时，我们将编写的汇编程序源文件编译后放在DOSBOX中执行并运行。而在这里，我们将编写后的源文件生成bin二进制机器码文件，并写入硬盘的主引导扇区并进行执行，以此体会虚拟机是如何从裸机（无操作系统）启动的，并复习如何显示内容。

##### 2、硬盘相关知识

编写主引导扇区代码前，需要了解磁道、盘面、柱面、扇区等相关术语知识。

图例：硬盘实体结构

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\1-硬盘.png)

我们重点关注片盘及其相关内部结构：

图例：实体硬盘结构

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\3-实体内部结构.png)

图例：抽象划分

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\2-内部结构抽象图.png)

图例：磁道和扇区

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\4-磁道及扇区.png)

结构说明：

- **盘片：**每个硬盘包含多个盘片，每个盘片可以是单面的，也可以是双面的。目前大多数硬盘都是双面结构。
- **盘面：**每个盘片包含正反两个盘面，它们编号从上到下依次是0号盘面、1号盘面、2号盘面、3号盘面，依次类推...
- **磁道：**每个盘面包含多个磁盘，从外层依次划分到内层，编号依次是0号磁道、1号磁道、2号磁道。注意每个盘片的正反两面磁道编号是一致的。分别读作0号盘面的0号磁道，1号盘面的0号磁道。
- **扇区：**每个磁道可以划分为多个相同大小的区域，这一个个区域被称作为扇区。扇区从1开始编号。每个扇区的大小通常是512Byte，也有可能更大，例如4KB，这取决于硬盘制造商。每个磁道能划分几个扇区同样取决于制造商，通常为63个。
- **柱面：**所有盘面相同位置的磁道组成一个柱面，从立体视角来看，形成一个圆柱。柱面数=磁道数。
- **磁头：**用来读写数据的机械臂头部部分。双面盘片自然有两个磁头，因此磁头数=盘面数，磁头编号也是从0开始的。*所有磁头连在同一个机械臂上的，因此它们移动时共同进退，这种方式影响了扇区存取数据*。

##### 3、如何确定某个扇区的具体位置？

​	我们可以按照刚才总结的硬盘结构知识来描述一下，例如：我要访问0号盘面的0号磁道的1号扇区，或者是0号磁头0号柱面的1号扇区。简称为0面0道1扇区。

一个硬盘的逻辑地址结构如下：

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\6-硬盘的地址.png)

##### 4、磁盘记录数据方式

​	刚才我们提到，磁头共同移动，共同进退，这影响了硬盘读写数据方式。没错，为了加速数据在硬盘上的读写，最好的办法就是尽量不移动磁头。这样，当0面的磁道不足以容纳要写入的数据时，应当把剩余的部分写在1面的同一磁道上。如果还写不下，那就继续把剩余的部分写在2面的同一磁道上。换句话说，在硬盘上，数据的访问是以柱面来组织的。柱面就是用来优化数据读写的概念。

##### 5、有关扇区的更多细节

- 扇区与扇区之间以间隙（空白）间隔开来，每个扇区以扇区头开始，然后是512字节的数据区。
- 扇区头包含了每个扇区自己的信息，主要有本扇区的磁道号、磁头号和扇区号，用来定位。

![](F:\my-computer\my-csapp\3-x86-Assembly-1\note\imgs\5-扇区.png)

##### 6、一切从主引导扇区开始

​	0面0道1扇区被规定为主引导扇区。如果计算机从硬盘启动，这BIOS将读取这个主引导扇区里的内容。然后加载到内存地址的0x0000:0x7c00处，然后通过jmp指令跳转到该处执行。

```assembly
jmp 0x0000:0x7c00
```

​	主引导扇区的功能就是继续从硬盘的其他部分读取更多的内容继续执行、知道加载操作系统成功，比较经典的windows操作系统就是这么干的。

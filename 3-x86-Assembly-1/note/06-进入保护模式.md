#### 进入保护模式

****

##### 1、全局描述符表

**段描述符：**

- 和一个段有关的信息需要8字节来描述，所以称为段描述符。
- 在内存中开辟出一段空间，集中存放段的描述符，构成了一个描述符表。
- 每个段都需要一个段描述符

**全局描述符表寄存器(GDTR)：**

图例：全局描述符表寄存器

![](.\imgs\24-全局描述符表寄存器.png)

- 处理器内部有一个48位的寄存器（即全局描述符表寄存器），用于跟踪全局描述符表。
- 高32位保存的是起始线性地址，对于32位处理器，拥有32根地址线，可访问的内存范围是`0x00000000`~`0xFFFFFFFF`，共4GB内存。
- 低16位保存的是全局描述符表的界限，也就是表的大小(总字节数)减1

**全局描述符表的大小：**

- 全局描述符表的第一个字节偏移量是0，最后1字节的偏移量是表大小减1

- 由于GDT的界限是16位的，所以该表最大为64KB(2^16=65536字节/1024)，注意GDT是按字节为单位的
- 一个描述符占8个字节，因此最多定义8192的描述符。

**表的存放位置：**

![](.\imgs\25-全局描述符表的存放位置.png)

- 全局描述符表必须在进入保护模式前定义，因为进入保护模式之后，处理器要立即按照新的内存访问模式工作。
- 由于实模式下只能访问1MB的内存，所以GDT通常都定义在1MB以下的内存范围中。可以在进入保护模式之后换个位置重新定义GDT。

##### 2、GDT的存放位置

在进入保护模式前，需要将GDT定义在内存中，并在其中安装段描述符。

图例：GDT的存放位置

<img src=".\imgs\26-GDT安装位置.png"  />

​	主引导程序占用512字节，要求存放在0x7c00开始处，那么它的内存范围就是0x7C00~0x7E00。我们将GDT放在0x7E00处，因为GDT最大范围为64KB，因此它可以扩展到0x17DFF处。

##### 3、段描述符的格式

![](.\imgs\27-段描述符格式.jpg)

- 每个描述符占8个字节，或者说64位，图中下面是低32位，上面是高32位。
- 段地址是32位的线性地址，如果未开启分页功能，那么这个地址就是真实的物理地址；反之，并非真实地址，需要左移4位。
- 段基地址可以是0~4GB内存范围内的任意地址，不过建议还是选择16字节对齐的地址。
- 段界限为20位，这实际上决定了段的大小。
  - 如果偏移量从0开始，偏移量的最大值就是段边界；
  - 如果偏移量从最大值往下递减，那么偏移量的最小值就是段边界。
- G位是粒度位，
  - G=0表示段界限以字节为单位，段的扩展范围为1KB~1MB。
  - G=1表示段界限以4KB为单位，段的扩展范围为4KB~4GB。
- S位-描述符类型，S=0表示该段是系统段，S=1表示该段是代码段或数据段
- DPL表示描述符特权级，级别为0、1、2、3，0是最高级别。特权级决定该程序能够执行哪些指令或访问哪些系统资源。
- P位表示该段是否存在内存中，PF=0表示不存在。当内存紧张时，有可能仅建立了某个段的描述符，但是该段并不在内存中。当使用时，再从硬盘调入到内存中，然后将P置为1。
- D/B位是默认操作尺寸位，设立该标志位，主要是为了兼容16位保护模式的程序。
  - D=0表示指令中的有效地址或者操作数是16位的。
  - D=1表示指令中的有效地址或者操作数是32位的。
  - 对于栈端，该位就是B位，B=0，段上部边界是0xFFFF；B=1，段的上部边界是0xFFFFFFFF。
- L位是64位代码段标志。保留此位给64位处理器使用。
- AVL是保留给软件自由使用的位。
- TYPE位表示描述符的子类型
  - 数据段解释为XEWA
    - X: exectuable是否可执行，数据段总是不可执行的，X=0
    - E指示段的扩展方向，E=0向上扩展。E=1向下扩展
    - W表示读写属性，W=0表示段不允许写入，W=1可以写入
    - A已访问位，表示段最近是否被访问，A=1段被访问。
  - 代码段解释为XCRA
    - C表示特权级依从，C=0表示不依从，特权同级的段可以相互调用。C=1表示从低特权级的程序转移到该段执行。
    - R表示代码段是否允许读出，R=0表示不能读出，强行读会引发处理器异常中断。